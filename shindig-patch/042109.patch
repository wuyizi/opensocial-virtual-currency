Index: build.bat
===================================================================
--- build.bat	(revision 0)
+++ build.bat	(revision 0)
@@ -0,0 +1 @@
+mvn install -Dmaven.test.skip=true
\ No newline at end of file
Index: certs/oauthkey.pem
===================================================================
--- certs/oauthkey.pem	(revision 0)
+++ certs/oauthkey.pem	(revision 0)
@@ -0,0 +1,16 @@
+-----BEGIN PRIVATE KEY-----
+MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAMz6gzVxSjl5T6yQ
+6/f5U/7nvfYtySEs7paSPXxOiyroX4NhSBELtSAjfBtzhVhncslOJKiDjdd2GgY6
+QbRT7iZ7/HY/rjQUL6YQI4oGa90ujKbpbM992ddbGnTs+J6yukPK+93T7PD6DX04
+n2AC/DwZlY4w2dDoLvyuZfVPWgt1AgMBAAECgYACu8yIJ+yfe5iuanhbJD4Uhi6o
+W8/0206LP4QGZl3AwryTWfbGE2vk89Qx4YaDuU10ldAzVx3LI84RCzHZH81rO9oG
+A9qPdZM7eX7ZzFASMSxDojZGhZE7MQTd7h/M8/ZCNSxO7Yy4EVP7CCJJx0OMXuSj
+i5Am25iFaX56AYgg+QJBAPCkl/aqMb7+6UcAUuoi0jbGMJDXQp2O9/Svx8/WuBIz
+rxMseOOr/rGyOhBtXOPhsMaoshDCRz2N2pVz+ebIJhMCQQDaD0RApU8I1QsSRNBA
+pN4U7qWoSAIVrHsnIcHpqOh0PCIQs9TeyGGSvZLLQBjtgcEW4G3u+PPFwjqyde+w
+ldlXAkEAnyRqryDc5y/TfDYVn2vJ05l8Er2Y+3PKPVJmdOfOMZNmi+qURBTByihQ
+x/5bOQVPkAGOSRECZg3C6aWaNepVawJAVAl4K1XKDMRWHPdKLu+a6wRB8YW2z/WG
+DMG0wsEmvM0D793uVuFwwSWwMgaE1Nuht5hMpcFp6Tf+eRJ8ilhlxwJARTkbZt5l
+u1MzXnx6t8lP6QM81fF8gD8u0PehU3rLGcGYmYxo7tJIgmjlvo5ZnMlJEGcAbX6y
+5AxJTpR+MQlAGg==
+-----END PRIVATE KEY-----
Index: certs/public.crt
===================================================================
--- certs/public.crt	(revision 0)
+++ certs/public.crt	(revision 0)
@@ -0,0 +1,13 @@
+-----BEGIN CERTIFICATE-----
+MIICCzCCAXSgAwIBAgIBADANBgkqhkiG9w0BAQQFADAUMRIwEAYDVQQDEwlteXRl
+c3RrZXkwHhcNMDkwMTE0MTQxMDU4WhcNMTAwMTE0MTQxMDU4WjAUMRIwEAYDVQQD
+EwlteXRlc3RrZXkwgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAOGjnuWg/sRs
+ZvCgUVUPBvM7ZMaLQdXR4f4uxQPEbsBpnj66v39axV3PtTZSOO1ELSaHMrCExyC8
+GZjKo0XUdoKVDRl7Uq2OqDr3/tPRfqKvWnxeJsiifO6t/Gjumhut+COJLz3EnfKs
+AzAhHnIUWdanBYpBqFnveQqaQYPPH7EnAgMBAAGjbTBrMB0GA1UdDgQWBBT0y0M4
+5mcXKw63GmynD4alHalEtTA8BgNVHSMENTAzgBT0y0M45mcXKw63GmynD4alHalE
+taEYpBYwFDESMBAGA1UEAxMJbXl0ZXN0a2V5ggEAMAwGA1UdEwQFMAMBAf8wDQYJ
+KoZIhvcNAQEEBQADgYEAysa0SF6CvxfPgQFhedskxrB8pwU5LRvSSzb3UGNaYeR8
+v/TL8xfToM6mP5hO0KYnq1AoTd4BK39OcY9SV9okJZT5S5JcwQWMY1KZJukeFQhn
+rNRr0LBd5Anv8fDW6+aiXHX+KpM9rNEDwfYplrPkoImxr/pqlAzb1azGYLNHuR0=
+-----END CERTIFICATE-----
Index: config/container.js
===================================================================
--- config/container.js	(revision 766937)
+++ config/container.js	(working copy)
@@ -64,12 +64,14 @@
 // iframeBaseUri will automatically have the host inserted
 // if locked domain is enabled and the implementation supports it.
 // query parameters will be added.
-"gadgets.iframeBaseUri" : "/gadgets/ifr",
+//"gadgets.iframeBaseUri" : "/gadgets/ifr",
+"gadgets.iframeBaseUri" : "http://www.myshindig.com:8080/gadgets/ifr",
 
 // jsUriTemplate will have %host% and %js% substituted.
 // No locked domain special cases, but jsUriTemplate must
 // never conflict with a lockedDomainSuffix.
-"gadgets.jsUriTemplate" : "http://%host%/gadgets/js/%js%",
+//"gadgets.jsUriTemplate" : "http://%host%/gadgets/js/%js%",
+"gadgets.jsUriTemplate" : "http://www.myshindig.com:8080/gadgets/js/%js%",
 
 // Use an insecure security token by default
 "gadgets.securityTokenType" : "insecure",
@@ -77,7 +79,8 @@
 // Config param to load Opensocial data for social
 // preloads in data pipelining.  %host% will be
 // substituted with the current host.
-"gadgets.osDataUri" : "http://%host%/social/rpc",
+//"gadgets.osDataUri" : "http://%host%/social/rpc",
+"gadgets.osDataUri" : "http://www.myshindig.com:8080/social/rpc",
 
 // Uncomment these to switch to a secure version
 // 
@@ -93,8 +96,10 @@
 "gadgets.features" : {
   "core.io" : {
     // Note: /proxy is an open proxy. Be careful how you expose this!
-    "proxyUrl" : "http://%host%/gadgets/proxy?refresh=%refresh%&url=%url%",
-    "jsonProxyUrl" : "http://%host%/gadgets/makeRequest"
+    //"proxyUrl" : "http://%host%/gadgets/proxy?refresh=%refresh%&url=%url%",
+    //"jsonProxyUrl" : "http://%host%/gadgets/makeRequest"
+    "proxyUrl" : "http://www.myshindig.com:8080/gadgets/proxy?refresh=%refresh%&url=%url%",
+    "jsonProxyUrl" : "http://www.myshindig.com:8080/gadgets/makeRequest"
   },
   "views" : {
     "profile" : {
@@ -113,7 +118,8 @@
     /// parameter if it passes input validation and is not null.
     // This should never be on the same host in a production environment!
     // Only use this for TESTING!
-    "parentRelayUrl" : "/gadgets/files/container/rpc_relay.html",
+    //"parentRelayUrl" : "/gadgets/files/container/rpc_relay.html",
+    "parentRelayUrl" : "http://www.mycontainer.com:8080/gadgets/files/container/rpc_relay.html",
 
     // If true, this will use the legacy ifpc wire format when making rpc
     // requests.
@@ -133,7 +139,8 @@
   "opensocial-0.8" : {
     // Path to fetch opensocial data from
     // Must be on the same domain as the gadget rendering server
-    "path" : "http://%host%/social",
+    //"path" : "http://%host%/social",
+    "path" : "http://www.myshindig.com:8080/social",
     "domain" : "shindig",
     "enableCaja" : false,
     "supportedFields" : {
@@ -143,7 +150,8 @@
   },
   "osapi.base" : {
     // Use EL when available.
-    "rpcUrl" : "http://%host%/social"
+    //"rpcUrl" : "http://%host%/social"
+    "rpcUrl" : "hhttp://www.myshindig.com:8080/social"
   }
 
 
Index: features/src/main/javascript/features/core.io/feature.xml
===================================================================
--- features/src/main/javascript/features/core.io/feature.xml	(revision 766937)
+++ features/src/main/javascript/features/core.io/feature.xml	(working copy)
@@ -35,4 +35,7 @@
   <gadget>
     <script src="io.js"/>
   </gadget>
+  <container><!-- This is only used for running the samplecontainer -->
+    <script src="io.js"/>
+  </container>
 </feature>
Index: features/src/main/javascript/features/core/feature.xml
===================================================================
--- features/src/main/javascript/features/core/feature.xml	(revision 766937)
+++ features/src/main/javascript/features/core/feature.xml	(working copy)
@@ -31,8 +31,12 @@
     <script src="legacy.js"/>
     <script src="log.js"/>
   </gadget>
-  <container>
+  <container><!-- Some of these are used for running the samplecontainer -->
+    <script src="core.js"/>
+    <script src="config.js"/>
     <script src="util.js"/>
+    <script src="auth.js"/>
+    <script src="auth-init.js"/>
     <script src="json.js"/>
   </container>
 </feature>
Index: features/src/main/javascript/features/features.txt
===================================================================
--- features/src/main/javascript/features/features.txt	(revision 766937)
+++ features/src/main/javascript/features/features.txt	(working copy)
@@ -19,6 +19,7 @@
 features/opensocial-data/feature.xml
 features/opensocial-data-context/feature.xml
 features/opensocial-jsonrpc/feature.xml
+features/opensocial-payment/feature.xml
 features/opensocial-reference/feature.xml
 features/opensocial-templates/feature.xml
 features/pubsub/feature.xml
Index: features/src/main/javascript/features/opensocial-jsonrpc/jsonrpccontainer.js
===================================================================
--- features/src/main/javascript/features/opensocial-jsonrpc/jsonrpccontainer.js	(revision 766937)
+++ features/src/main/javascript/features/opensocial-jsonrpc/jsonrpccontainer.js	(working copy)
@@ -44,6 +44,11 @@
 
   gadgets.rpc.register('shindig.requestShareApp_callback',
       JsonRpcContainer.requestShareAppCallback_);
+
+  gadgets.rpc.register('shindig.requestPayment_callback',
+      JsonRpcContainer.requestPaymentCallback_);
+
+      
 };
 
 (function() {
@@ -69,6 +74,43 @@
     return this.environment_;
   };
 
+
+  JsonRpcContainer.prototype.requestPayment = function(payment, 
+      opt_paymentHandlerUrl, opt_callback) {
+    if (!payment) {
+      if (opt_callback) {
+        opt_callback(new opensocial.ResponseItem(null, payment, 
+          opensocial.Payment.ResponseCode.MALFORMED_REQUEST, 
+          'Payment object is undefined.'));
+      }
+      return;
+    }
+    
+    var callbackId = 'cId_' + Math.random();
+    callbackIdStore[callbackId] = opt_callback;
+    gadgets.rpc.call('..', 'shindig.requestPayment',
+        null,
+        callbackId,
+        payment['fields_'],
+        opt_paymentHandlerUrl);
+  };
+  
+  
+  JsonRpcContainer.requestPaymentCallback_ = function(callbackId, paymentParams) {
+    callback = callbackIdStore[callbackId];
+    if (callback) {
+      var errorCode = opensocial.Payment.ResponseCode[
+          paymentParams[opensocial.Payment.Field.RESPONSE_CODE]];
+      paymentParams[opensocial.Payment.Field.RESPONSE_CODE] = errorCode;
+      var payment = new opensocial.Payment(paymentParams);
+      var responseItem = new opensocial.ResponseItem(null, payment, 
+          (errorCode == opensocial.Payment.ResponseCode.OK ? null : errorCode),
+          payment.getField(opensocial.Payment.Field.RESPONSE_MESSAGE));
+      callback(responseItem);
+    }
+  };
+  
+  
   JsonRpcContainer.prototype.requestShareApp = function(recipientIds, reason,
       opt_callback, opt_params) {
     var callbackId = "cId_" + Math.random();
@@ -487,6 +529,11 @@
 };
 
 
+JsonRpcContainer.prototype.newFetchPaymentRequest = function(id, opt_params) {
+  throw new Error('Not implemented.');
+};
+
+
 var JsonRpcRequestItem = function(rpc, opt_processData) {
   this.rpc = rpc;
   this.processData = opt_processData ||
Index: features/src/main/javascript/features/opensocial-payment/feature.xml
===================================================================
--- features/src/main/javascript/features/opensocial-payment/feature.xml	(revision 0)
+++ features/src/main/javascript/features/opensocial-payment/feature.xml	(revision 0)
@@ -0,0 +1,26 @@
+<?xml version="1.0"?>
+<!--
+Licensed to the Apache Software Foundation (ASF) under one
+or more contributor license agreements. See the NOTICE file
+distributed with this work for additional information
+regarding copyright ownership. The ASF licenses this file
+to you under the Apache License, Version 2.0 (the
+"License"); you may not use this file except in compliance
+with the License. You may obtain a copy of the License at
+
+http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing,
+software distributed under the License is distributed on an
+"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+KIND, either express or implied. See the License for the
+specific language governing permissions and limitations under the License.
+-->
+<feature>
+  <name>opensocial-payment</name>
+  <dependency>core.io</dependency>
+  <dependency>rpc</dependency>
+  <container>
+    <script src="paymentprocessor.js"/>
+  </container>
+</feature>

Property changes on: features\src\main\javascript\features\opensocial-payment\feature.xml
___________________________________________________________________
Added: svn:mime-type
   + text/xml
Added: svn:eol-style
   + native

Index: features/src/main/javascript/features/opensocial-payment/paymentprocessor.js
===================================================================
--- features/src/main/javascript/features/opensocial-payment/paymentprocessor.js	(revision 0)
+++ features/src/main/javascript/features/opensocial-payment/paymentprocessor.js	(revision 0)
@@ -0,0 +1,254 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * 'License'); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations under the License.
+ */
+
+/**
+ * @fileoverview Container-side codes as a processor for the virtual currency
+ * payment functionality.
+ */
+
+var shindig = shindig || {};
+
+/**
+ * @static
+ * @class Provides the virtual currency payment processor features on 
+          container side. Handles the payment request from app, prompts the 
+          container processor page for user to confirm the payment, and 
+          passes the response back to the app. The container need to implement 
+          four event functions to fulfill the functionality.
+ * @name gadgets.paymentprocessor
+ */
+shindig.paymentprocessor = (function() {
+
+  var frameId_;
+  
+  var callbackId_;
+
+  /**
+   * The state indicating if the processor panel is on or off.
+   * @type {boolean}
+   */
+  var isOpened_ = false;
+
+  /**
+   * The state indicating if the processor panel is committed.
+   * @type {boolean}
+   */
+  var isSubmitted_ = false;
+
+  /**
+   * A parameters set of the payment. It is passed in from app side, filled 
+   * up during the whole procedure. 
+   * <p>
+   * Note that this object is serialized and 
+   * passed through RPC channel so all functions are lost.
+   * </p>
+   * @type {Object.<string, Object>}
+   */
+  var paymentParams_ = null;
+
+  /**
+   * A set of extra params for the payment procedure that need to passed to 
+   * container processor panel page.
+   * @type {Object.<string, Object>}
+   */
+  var extraParams_ = null;
+
+  /**
+   * A set of event functions which allow customizing the UI and actions of the
+   * processor panel by container.
+   * @type {Object.<string, Function>}
+   */
+  var events_ = null;
+  
+  
+
+
+  /**
+   * Handles the request called via rpc from gadgets.pay.requestPay on the
+   * app side. Turns on the processor and initializes the reqParams and
+   * resParams.
+   * <p>
+   * The 'this' in this function is the rpc object, thus contains
+   * some information of the app.
+   * </p>
+   * @param {Object} paymentParams The payment parameters from the app,
+   *         with AMOUNT, MESSAGE and PARAMETERS fields set. It's the 'fields_'
+   *         property of opensocial.Payment object.
+   * @param {String} paymentHandlerUrl The payment endpoint on app backend.
+   */
+  function open_(callbackId, paymentParams, paymentHandlerUrl) {
+    if (isOpened_) {
+      // Shouldn't continue if the processor is already opened.
+      try {
+        paymentParams['responseCode'] = 'PAYMENT_PROCESSOR_ALREADY_OPENED';
+        gadgets.rpc.call(this.f, 'shindig.requestPayment_callback',
+            null, callbackId, paymentParams);
+      } finally {
+        return;
+      }
+    }
+    
+    if (!paymentParams['amount'] || 
+        paymentParams['amount'] <= 0) {
+      // TODO: Need more check on the AMOUNT value and other values.
+      try {
+        paymentParams['responseCode'] = 'MALFORMED_REQUEST';
+        gadgets.rpc.call(this.f, 'shindig.requestPayment_callback',
+            null, callbackId, paymentParams);
+      } finally {
+        return;
+      }
+    }
+
+    
+    // Initialize the params data.
+    frameId_ = this.f;
+    callbackId_ = callbackId;
+    extraParams_ = {};
+    paymentParams_ = paymentParams;
+    paymentParams_['orderedTime'] = new Date().getTime();
+    paymentParams_['message'] = 
+        gadgets.util.escapeString(paymentParams_['message']);
+    // This part need the gadgets.container service
+    if (gadgets.container && gadgets.container.gadgetService) {
+      var thisGadget = gadgets.container.getGadget(
+          gadgets.container.gadgetService.getGadgetIdFromModuleId(frameId_));
+      if (thisGadget) {
+        extraParams_['appTitle'] = thisGadget['title'];
+        extraParams_['appSpec'] = thisGadget['specUrl'];
+      }
+    } else {
+      extraParams_['appTitle'] = 'Unknown Title';
+      extraParams_['appSpec'] = 'Unknown SpecUrl';
+    }
+
+    extraParams_['handlerUrl'] = paymentHandlerUrl;
+    
+    isOpened_ = true;
+    isSubmitted_ = false;
+
+    // Call the container's open event to display the processor panel UI.
+    if (events_.openEvent) {
+      events_.openEvent(paymentParams_, extraParams_, submit_, cancel_);
+    } else {
+      // The open event is not optional.
+      // If not set, then close the processor.
+      paymentParams_['responseCode', 'NOT_IMPLEMENTED'];
+      close_();
+    }
+  };
+
+  /**
+   * Handles the submit button click event by the user.
+   * It calls the submit event to the pay request to container
+   * virtual currency api with Ajax POST.
+   */
+  function submit_() {
+    if (!isOpened_) {
+      return;
+    }
+    // The committed time is the time when user click the submit button.
+    paymentParams_['submittedTime'] = new Date().getTime();
+
+    // Call the container's submit event to actual do the virtual currency
+    // change on container backend via Ajax POST.
+    // The resParams's RESPONSE_CODE and EXECUTED_TIME will be set in this event.
+    if (events_.submitEvent) {
+      events_.submitEvent(paymentParams_, extraParams_, close_);
+      isSubmitted_ = true;
+    } else {
+      // The submit event is not optional.
+      // If not set, then close the processor.
+      paymentParams_['responseCode'] = 'NOT_IMPLEMENTED';
+      close_();
+    }
+  };
+
+  /**
+   * Handles the cancel button click event by the user.
+   */
+  function cancel_() {
+    if (!isOpened_ || isSubmitted_) {
+      return;
+    }
+
+    paymentParams_['responseCode'] = 'USER_CANCELLED';
+
+    // Call the container's cancel event to do some UI change if needed.
+    if (events_.cancelEvent) {
+      events_.cancelEvent(paymentParams_, extraParams_, close_);
+    } else {
+      // The cancel event is optional.
+      // If not set, close the processor directly.
+      close_();
+    }
+  };
+
+  /**
+   * Closes the processor panel.
+   * It hide the processor panel itself in the close event.
+   */
+  function close_() {
+    if (!isOpened_) {
+      return;
+    }
+
+    // Call the container's close event to hide the processor panel.
+    if (events_.closeEvent) {
+      events_.closeEvent(paymentParams_, extraParams_);
+    }
+    // The close event is optional. If not set, do nothing.
+    // (NOTE that the panel is still visible if do nothing...)
+
+    try {
+      // Call the app back via rpc.
+      gadgets.rpc.call(frameId_, 'shindig.requestPayment_callback',
+                       null,
+                       callbackId_,
+                       paymentParams_);
+    } finally {
+      isOpened_ = false;
+      paymentParams_ = null;
+      extraParams_ = null;
+    }
+  };
+
+  return /** @scope gadgets.paymentprocessor */ {
+    /**
+     * Initializes the 'payment' rpc. It's called by container processor page in
+     * onload function.
+     * @param {Function} openevent The event function for handling the opening
+     *        UI.
+     * @param {Function} submitEvent The event function for real interaction
+     *        with the container api server.
+     * @param {Function} cancelevent The event function for handling the
+     *        cancel action UI.
+     * @param {Function} closeevent The event function for handling the
+     *        disposing UI.
+     */
+    init: function(openEvent, submitEvent, cancelEvent, closeEvent) {
+      events_ = {};
+      events_.openEvent = openEvent;
+      events_.submitEvent = submitEvent;
+      events_.cancelEvent = cancelEvent;
+      events_.closeEvent = closeEvent;
+      gadgets.rpc.register('shindig.requestPayment', open_);
+    }
+  };
+
+})();

Property changes on: features\src\main\javascript\features\opensocial-payment\paymentprocessor.js
___________________________________________________________________
Added: svn:mime-type
   + text/javascript
Added: svn:eol-style
   + native

Index: features/src/main/javascript/features/opensocial-reference/container.js
===================================================================
--- features/src/main/javascript/features/opensocial-reference/container.js	(revision 766937)
+++ features/src/main/javascript/features/opensocial-reference/container.js	(working copy)
@@ -73,6 +73,19 @@
  */
 opensocial.Container.prototype.getEnvironment = function() {};
 
+
+opensocial.Container.prototype.requestPayment = function(payment, 
+    opt_paymentHandlerUrl, opt_callback) {
+  if (opt_callback) {
+    window.setTimeout(function() {
+      opt_callback(new opensocial.ResponseItem(
+          null, payment, opensocial.Payment.ResponseCode.NOT_IMPLEMENTED, 
+          null));
+    }, 0);
+  }
+};
+
+
 /**
  * Requests the container to send a specific message to the specified users. If
  * the container does not support this method the callback will be called with a
@@ -318,6 +331,9 @@
 opensocial.Container.prototype.newFetchMessageCollectionsRequest = function(idSpec, opt_params) {};
 opensocial.Container.prototype.newFetchMessagesRequest = function(idSpec, msgCollId, opt_params) {};
 
+opensocial.Container.prototype.newFetchPaymentRequest = function(id, opt_params) {};
+
+
 /**
  * Creates a new collection with caja support if enabled.
  * @return {opensocial.Collection} the collection object
@@ -474,6 +490,19 @@
 
 
 /**
+ * Creates a payment object.
+ * @param {Map.&lt;opensocial.Payment.Field, Object&gt;} params
+ *     Parameters defining the payment object.
+ * @return {opensocial.Payment} The new
+ *     <a href="opensocial.Payment.html">Payment</a> object
+ * @private
+ */
+opensocial.Container.prototype.newPayment = function(params) {
+  return new opensocial.Payment(params);
+};
+
+
+/**
  * Returns true if the specified value is an array
  * @param {Object} val Variable to test
  * @return {boolean} Whether variable is an array
Index: features/src/main/javascript/features/opensocial-reference/datarequest.js
===================================================================
--- features/src/main/javascript/features/opensocial-reference/datarequest.js	(revision 766937)
+++ features/src/main/javascript/features/opensocial-reference/datarequest.js	(working copy)
@@ -535,3 +535,53 @@
   opt_params = opt_params || {};
   return opensocial.Container.get().newFetchMessagesRequest(idSpec, msgCollId, opt_params);
 };
+
+
+
+/**
+ * @static
+ * @class
+ * @name opensocial.DataRequest.PaymentRequestFields
+ */
+opensocial.DataRequest.PaymentRequestFields = {
+  /**
+   * @member opensocial.DataRequest.PaymentRequestFields
+   */
+  TYPE : 'type',
+  
+  /**
+   * @member opensocial.DataRequest.PaymentRequestFields
+   */
+  IS_COMPLETE : 'isComplete',
+  
+  /**
+   * @member opensocial.DataRequest.PaymentRequestFields
+   */
+  MAX : 'max',
+  
+  /**
+   * @member opensocial.DataRequest.PaymentRequestFields
+   */
+  START_TIME : 'startTime'
+};
+
+/**
+ * 
+ * @param {String} id The ID of the person to fetch; only the
+ *     special <code>VIEWER</code> ID is currently allowed.
+ * @param {Map.&lt;opensocial.DataRequest.PaymentRequestFields, Object&gt;}
+ *  opt_params Additional parameters to pass to the request.
+ * @return {Object} A request object
+ */
+opensocial.DataRequest.prototype.newFetchPaymentRequest = function(id,
+    opt_params) {
+  opt_params = opt_params || {};
+  var fields = opensocial.DataRequest.PaymentRequestFields;
+  
+  this.addDefaultParam(opt_params, fields.MAX, 5);
+  this.addDefaultParam(opt_params, fields.START_TIME, 
+      new Date().getTime() - 86400000000);  // one day before.
+    
+  return opensocial.Container.get().newFetchPaymentRequest(id, opt_params);
+};
+
Index: features/src/main/javascript/features/opensocial-reference/feature.xml
===================================================================
--- features/src/main/javascript/features/opensocial-reference/feature.xml	(revision 766937)
+++ features/src/main/javascript/features/opensocial-reference/feature.xml	(working copy)
@@ -38,6 +38,7 @@
     <script src="name.js"/>
     <script src="navigationparameters.js"/>
     <script src="organization.js"/>
+    <script src="payment.js"/>
     <script src="person.js"/>
     <script src="phone.js"/>
     <script src="responseitem.js"/>
Index: features/src/main/javascript/features/opensocial-reference/opensocial.js
===================================================================
--- features/src/main/javascript/features/opensocial-reference/opensocial.js	(revision 766937)
+++ features/src/main/javascript/features/opensocial-reference/opensocial.js	(working copy)
@@ -39,6 +39,12 @@
 var opensocial = opensocial || {};
 
 
+opensocial.requestPayment = function(payment, opt_paymentHandlerUrl, opt_callback) {
+  opensocial.Container.get().requestPayment(payment, opt_paymentHandlerUrl,
+      opt_callback);
+};
+
+
 /**
  * Requests the container to send a specific message to the specified users.
  *
@@ -448,6 +454,20 @@
 };
 
 
+/**
+ * Creates a payment object.
+ *
+ * @param {Map.&lt;opensocial.Payment.Field, Object&gt;} params
+ *    Parameters defining the payment object.
+ * @return {opensocial.Payment} The new
+ *     <a href="opensocial.Payment.html">Payment</a> object
+ * @member opensocial
+ */
+opensocial.newPayment = function(params) {
+  return opensocial.Container.get().newPayment(params);
+};
+
+
 // TODO(doll): Util function - pull up the gadgets inherits in shindig so that
 // opensocial and gadgets use the same one
 /** @private */
Index: features/src/main/javascript/features/opensocial-reference/payment.js
===================================================================
--- features/src/main/javascript/features/opensocial-reference/payment.js	(revision 0)
+++ features/src/main/javascript/features/opensocial-reference/payment.js	(revision 0)
@@ -0,0 +1,235 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied.  See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+
+/**
+ * @class
+ * Representation of a payment.
+ ¡Á
+ * @name opensocial.Payment
+ */
+
+
+/**
+ * Base interface for all activity objects.
+ *
+ * Private, see opensocial.createActivity() for usage.
+ *
+ * @param {Map.&lt;opensocial.Activity.Field, Object&gt;} params
+ *    Parameters defining the activity.
+ * @private
+ * @constructor
+ */
+opensocial.Payment = function(params) {
+  this.fields_ = params || {};
+  this.fields_[opensocial.Payment.Field.PAYMENT_TYPE] = 
+      this.fields_[opensocial.Payment.Field.PAYMENT_TYPE] || 
+      opensocial.Payment.PaymentType.PAYMENT;
+};
+
+
+
+opensocial.Payment.prototype.isPayment = function() {
+  return this.fields_[opensocial.Payment.Field.PAYMENT_TYPE] == 
+      opensocial.Payment.PaymentType.PAYMENT;
+};
+
+opensocial.Payment.prototype.isCredit = function() {
+  return this.fields_[opensocial.Payment.Field.PAYMENT_TYPE] == 
+      opensocial.Payment.PaymentType.CREDIT;
+};
+
+opensocial.Payment.prototype.isComplete = function() {
+  return !!this.fields_[opensocial.Payment.Field.PAYMENT_COMPLETE];
+};
+
+
+/**
+ * @static
+ * @class
+ * All of the fields that a payment object can have.
+ *
+ * <p>The AMOUNT, MESSAGE, PARAMETERS are required for the request. </p>
+ *
+ * <p>And the ORDER_ID, ORDERED_TIME, SUBMITTED_TIME, EXECUTED_TIME fields 
+ * will be filled during the procedure and return to the app. </p>
+ * <p>
+ * <b>See also:</b>
+ * <a
+ * href="opensocial.Payment.html#getField">opensocial.Payment.getField()</a>
+ * </p>
+ *
+ * @name opensocial.Payment.Field
+ */
+opensocial.Payment.Field = {
+  /**
+   * @member opensocial.Payment.Field
+   */
+  AMOUNT : 'amount',
+
+  /**
+   * @member opensocial.Payment.Field
+   */
+  MESSAGE : 'message',
+
+  /**
+   * @member opensocial.Payment.Field
+   */
+  PARAMETERS : 'parameters',
+  
+  /**
+   * @member opensocial.Payment.Field
+   */
+  PAYMENT_TYPE : 'paymentType',
+  
+  /**
+   * @member opensocial.Payment.Field
+   */
+  ORDER_ID : 'orderId',
+  
+  /**
+   * @member opensocial.Payment.Field
+   */
+  ORDERED_TIME : 'orderedTime',
+  
+  /**
+   * @member opensocial.Payment.Field
+   */
+  SUBMITTED_TIME : 'submittedTime',
+
+  /**
+   * @member opensocial.Payment.Field
+   */
+  EXECUTED_TIME : 'executedTime',
+  
+  /**
+   * @member opensocial.Payment.Field
+   */
+  RESPONSE_CODE : 'responseCode',
+  
+  /**
+   * @member opensocial.Payment.Field
+   */
+  RESPONSE_MESSAGE : 'responseMessage',
+  
+  /**
+   * @member opensocial.Payment.Field
+   */
+  PAYMENT_COMPLETE : 'paymentConmplete'
+
+};
+
+
+/**
+ * Gets the payment field data that's associated with the specified key.
+ *
+ * @param {String} key The key to get data for;
+ *   see the <a href="opensocial.Payment.Field.html">Field</a> class
+ * for possible values
+ * @param {Map.&lt;opensocial.DataRequest.DataRequestFields, Object&gt;}
+ *  opt_params Additional
+ *    <a href="opensocial.DataRequest.DataRequestFields.html">params</a>
+ *    to pass to the request.
+ * @return {String} The data
+ * @member opensocial.Payment
+ */
+opensocial.Payment.prototype.getField = function(key, opt_params) {
+  return opensocial.Container.getField(this.fields_, key, opt_params);
+};
+
+
+/**
+ * Sets data for this payment associated with the given key.
+ *
+ * @param {String} key The key to set data for
+ * @param {String} data The data to set
+ */
+opensocial.Payment.prototype.setField = function(key, data) {
+  return this.fields_[key] = data;
+};
+
+
+opensocial.Payment.PaymentType = {
+  /**
+   * @member opensocial.Payment.PaymentType
+   */
+  PAYMENT : 'payment',
+
+  /**
+   * @member opensocial.Payment.PaymentType
+   */
+  CREDIT : 'credit'
+};
+
+
+opensocial.Payment.ResponseCode = {
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  APP_LOGIC_ERROR : 'appLogicError',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  APP_NETWORK_FAILURE : 'appNetworkFailure',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  INSUFFICIENT_MONEY : 'insufficientMoney',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  INVALID_TOKEN : 'invalidToken',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  MALFORMED_REQUEST : 'malformedRequest',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  NOT_IMPLEMENTED : 'notImplemented',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  OK : 'ok',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  PAYMENT_ERROR : 'paymentError',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  PAYMENT_PROCESSOR_ALREADY_OPENED : 'paymentProcessorAlreadyOpened',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  UNKNOWN_ERROR : 'unknownError',
+
+  /**
+   * @member opensocial.Payment.ResponseCode
+   */
+  USER_CANCELLED : 'userCancelled',
+};

Property changes on: features\src\main\javascript\features\opensocial-reference\payment.js
___________________________________________________________________
Added: svn:mime-type
   + text/javascript

Index: java/common/conf/shindig.properties
===================================================================
--- java/common/conf/shindig.properties	(revision 766937)
+++ java/common/conf/shindig.properties	(working copy)
@@ -13,8 +13,8 @@
 shindig.oauth.base-url=/oauth/
 shindig.oauth.authorize-action=/WEB-INF/authorize.jsp
 shindig.oauth.legacy-body-signing=true
-shindig.signing.key-name=
-shindig.signing.key-file=
+shindig.signing.key-name=/gadgets/files/public.crt
+shindig.signing.key-file=res://certs/oauthkey.pem
 
 # If enabled here, configuration values can be found in container configuration files.
 shindig.locked-domain.enabled=false
Index: java/server/pom.xml
===================================================================
--- java/server/pom.xml	(revision 766937)
+++ java/server/pom.xml	(working copy)
@@ -58,6 +58,13 @@
               </includes>
             </resource>
             <resource>
+              <directory>${basedir}/../../certs/</directory>
+              <targetPath>gadgets/files</targetPath>
+              <includes>
+                <include>public.crt</include>
+              </includes>
+            </resource>
+            <resource>
               <targetPath>META-INF</targetPath>
               <directory>target/maven-shared-archive-resources/META-INF</directory>
               <includes>
@@ -100,6 +107,13 @@
         </includes>
       </resource>
       <resource>
+        <targetPath>certs</targetPath>
+        <directory>${basedir}/../../certs</directory>
+        <includes>
+          <include>oauthkey.pem</include>
+        </includes>
+      </resource>
+      <resource>
         <directory>conf</directory>
       </resource>
     </resources>
Index: javascript/container/gadgets.js
===================================================================
--- javascript/container/gadgets.js	(revision 766937)
+++ javascript/container/gadgets.js	(working copy)
@@ -464,7 +464,8 @@
 
 gadgets.IfrGadget = function(opt_params) {
   gadgets.Gadget.call(this, opt_params);
-  this.serverBase_ = '../../'; // default gadget server
+  //this.serverBase_ = '../../'; // default gadget server
+  this.serverBase_ = 'http://www.myshindig.com:8080/gadgets/';
 };
 
 gadgets.IfrGadget.inherits(gadgets.Gadget);
Index: javascript/container/sample-payment-processor.html
===================================================================
--- javascript/container/sample-payment-processor.html	(revision 0)
+++ javascript/container/sample-payment-processor.html	(revision 0)
@@ -0,0 +1,332 @@
+<!DOCTYPE html>
+<html>
+<head>
+<title>Sample: Pay Counter</title>
+
+<style>
+body, td, div, span, p {
+  font-family:arial,sans-serif;
+}
+body {
+  padding:0px;
+  margin:0px;
+}
+.payment-processor-shadow {
+  filter: alpha(opacity=30);
+  -moz-opacity:.3;
+  opacity:0.3;
+  background-color:#000;
+  width:490px;
+  height:290px;
+  margin:5px 0px 0px 5px;
+  position:absolute;
+  z-index:100;
+}
+.payment-processor-border1 {
+  background-color:#E5ECF9;
+  width:490px;
+  height:290px;
+  position:absolute;
+  z-index:200;
+}
+.payment-processor-border2 {
+  background-color:#FFF;
+  margin:5px;
+  height:280px;
+}
+.payment-processor-content {
+  padding:20px;
+  font-size:13px;
+}
+.payment-processor-content #loading-tab {
+  color:#777;
+}
+.caption {
+  font-weight:bold;
+  width:80px;
+  display:inline;
+}
+.desc {
+  color:#007F00;
+}
+</style>
+
+<script type="text/javascript">
+
+/**
+ * @static
+ * @class Provides the UI and logic for the real payment excution on
+ *        container api server. This page is embeded in the parent
+ *        container page as an iframe.
+ *        All functions or logis or names in this page are customizable.
+ *        Indeed containers have to customize them to make the UI consistent.
+ *
+ */
+myProcessorPanel = (function() {
+  var parentDiv;
+
+  /**
+   * Draws the pay counter panel UI itself.
+   * (NOTE that this page is a iframe in its parent container window);
+   * Assigns the submit callback and cancel callback to the buttons.
+   * So from this panel, submit or cancel actions can be made.
+   *
+   * @param {Object} paymentParams The payment parameters.
+   * @param {Object} extraParams The extra parameters for the payment 
+   *                 procedure, including handler url, app title and spec.
+   * @param {Function} submitCallback The submit callback in 
+   *                   <code>shindig.paymentprocessor</code>.
+   * @param {Function} cancelCallback The cancel callback in 
+   *                   <code>shindig.paymentprocessor</code>.
+   */
+  function openEvent(paymentParams, extraParams, submitCallback, cancelCallback) {
+    // Set the UI.
+    document.getElementById('loading-tab').style.display = 'none';
+    
+    document.getElementById('payment-type').innerHTML = paymentParams['paymentType'];
+    document.getElementById('payment-amount').innerHTML = paymentParams['amount'];
+    document.getElementById('payment-message').innerHTML = paymentParams['message'];
+    document.getElementById('payment-appname').innerHTML = extraParams['appTitle'];
+    document.getElementById('payment-appspec').innerHTML = extraParams['appSpec'];
+    document.getElementById('payment-orderedtime').innerHTML = new Date(paymentParams['orderedTime']);
+    
+    if (paymentParams['paymentType'] == 'credit') {
+      // If the payment type is 'credit', skip the confirm panel UI and 
+      // call the submitCallback directly.
+      window.setTimeout(submitCallback, 500);
+    } else {
+      // If the payment type is normal 'payment', add click listeners and 
+      // wait for user confirmation.
+      document.getElementById('button-tab').style.display = 'block';
+      document.getElementById('payment-submit').onclick = submitCallback;
+      document.getElementById('payment-cancel').onclick = cancelCallback;
+    }
+
+    // Set the div in the parent window to visible.
+    parentDiv.style.display = 'block';
+  };
+
+  /**
+   * Called by <code>shindig.paymentprocessor</code> after the submit button 
+   * clicked by the user.
+   *
+   * This function should send the pay request to container virtual currency
+   * api with Ajax POST.
+   *
+   * Then usually an acknowledge tab will be shown in the  with a botton to
+   * call the callback function.
+   *
+   * @param {Object} paymentParams The payment parameters.
+   * @param {Object} extraParams The extra parameters for the payment 
+   *                 procedure, including handler url, app title and spec.
+   * @param {Function} closeCallback The close callback in 
+   *                   <code>shindig.paymentprocessor</code>.
+   */
+  function submitEvent(paymentParams, extraParams, closeCallback) {
+    document.getElementById('button-tab').style.display = 'none';
+    document.getElementById('loading-tab').style.display = 'block';
+
+    // -- SAMPLE FAKE CODE --
+    
+    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */  
+    /* * Here the javascript should do an AJAX post to the container 
+    /* * server with handler url, payment object and security token
+    /* * and the container will do a signed fetch to app backend server and
+    /* * execute the payment procedure.
+    /* */
+    /* * So the following should be done in server side.  
+    /* * Here use javascript and signed makeRequest to illustrate the logic 
+    /* * flow as a demo. Because from the view of the app backend, it receives
+    /* * requests in the same format.
+    /* */
+    /* */
+    /* */  // The function which do the payment on user's account
+    /* */  var paymentFunc = function(paymentParams, extraParams) {
+    /* */    // Just a fake test to stimulate container server error.
+    /* */    if (paymentParams['amount'] == 555) {
+    /* */      paymentParams['responseCode'] = 'PAYMENT_ERROR';
+    /* */      paymentParams['responseMessage'] = 'Fake error on container money server.';
+    /* */    } else {
+    /* */      paymentParams['responseCode'] = 'OK';
+    /* */      paymentParams['paymentComplete'] = true;
+    /* */    }
+    /* */    paymentParams['executedTime'] = new Date().getTime();
+    /* */  };
+    /* */
+    /* */
+    /* */  // 1. Check the amount and user's or app's account. Here is just a fack check.
+    /* */  if (paymentParams['paymentType'] == 'payment' && paymentParams['amount'] > 1000) {
+    /* */    paymentParams['responseCode'] = 'INSUFFICIENT_MONEY';
+    /* */    paymentParams['responseMessage'] = 'The user do not have enough money to pay.';
+    /* */    closeCallback();
+    /* */    return;
+    /* */  } else if (paymentParams['paymentType'] == 'credit' && paymentParams['amount'] > 10000) {
+    /* */    paymentParams['responseCode'] = 'INSUFFICIENT_MONEY';
+    /* */    paymentParams['responseMessage'] =  'The app do not have enough money to give credit.';
+    /* */    closeCallback();
+    /* */    return;
+    /* */  }    
+    /* */
+    /* */  // 2. Assign an unique order id
+    /* */  paymentParams['orderId'] = 'TODO_ORDER_ID_' + Math.round(Math.random() * 10E10);
+    /* */  
+    /* */  // 3. Due with the app without any backend and sends an empty url.
+    /* */  //    Maybe some insert-coin-game will use an empty checkout url.
+    /* */  if (extraParams['handlerUrl'] == null || 
+    /* */      extraParams['handlerUrl'] == '') {
+    /* */    // Call the real money off function with the AMOUNT
+    /* */    paymentFunc(paymentParams, extraParams);
+    /* */    paymentParams['responseMessage'] = 'This payment is made without app backends.';
+    /* */    closeCallback();
+    /* */    return;
+    /* */  }
+    /* */
+    /* */
+    /* */  // 4. Due with the app with a backend. The container server will 
+    /* */  //    first send a signed fetch to the app backend, and cost user
+    /* */  //    money after the app backend responded.
+    /* */  var gadgets = parent.gadgets;
+    /* */  var ioParams = {};
+    /* */  ioParams[gadgets.io.RequestParameters.AUTHORIZATION] = 
+    /* */      gadgets.io.AuthorizationType.SIGNED;
+    /* */  ioParams[gadgets.io.RequestParameters.CONTENT_TYPE] = 
+    /* */      gadgets.io.ContentType.JSON;
+    /* */  ioParams[gadgets.io.RequestParameters.METHOD] = 
+    /* */      gadgets.io.MethodType.POST;
+    /* */
+    /* */  // Merge reqParams and resParams for the post data to app backend
+    /* */  var postData = paymentParams;
+    /* */  ioParams[gadgets.io.RequestParameters.POST_DATA] = 
+    /* */      gadgets.io.encodeValues(postData);
+    /* */  
+    /* */  if (window.console) {
+    /* */    window.console.info('Object sent to app backend:');
+    /* */    window.console.log(postData);
+    /* */    window.console.log(gadgets.io.encodeValues(postData));
+    /* */  }
+    /* */  
+    /* */  gadgets.io.makeRequest(extraParams['handlerUrl'], function (obj) {
+    /* */    // Check the app backend response.
+    /* */
+    /* */    if (obj.rc != 200) {
+    /* */      // app backend is not reachable.
+    /* */      paymentParams['responseCode'] = 'APP_NETWORK_FAILURE';
+    /* */      paymentParams['responseMessage'] = 'App payment handler URL replied ' + obj.rc;
+    /* */      closeCallback();
+    /* */      return;
+    /* */    }
+    /* */    
+    /* */    if (window.console) {
+    /* */      window.console.info('Object received from app backend:');
+    /* */      window.console.log(obj);
+    /* */      window.console.log(obj.data);
+    /* */    }
+    /* */
+    /* */    // Copy the two response values from app backend reply.
+    /* */    paymentParams['responseCode'] = obj.data['responseCode'];
+    /* */    paymentParams['responseMessage'] = obj.data['responseMsg'];
+    /* */    
+    /* */    switch(obj.data['responseCode']) {
+    /* */      case 'OK':  
+    /* */        // Call the real money off function with the AMOUNT
+    /* */        paymentFunc(paymentParams, extraParams);
+    /* */        break;
+    /* */
+    /* */      case 'APP_LOGIC_ERROR':
+    /* */        // do something if any
+    /* */        break;
+    /* */
+    /* */      default:
+    /* */        // something unexpected happens
+    /* */        paymentParams['responseCode'] = 'UNKNOWN_ERROR';
+    /* */        break;
+    /* */    }
+    /* */    closeCallback();
+    /* */  }, ioParams);
+    /* */
+    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
+    
+    // -- END OF SAMPLE --
+  };
+
+  /**
+   * Called by <code>shindig.paymentprocessor</code> after the cancel button 
+   * was clicked by user.
+   * @param {Object} paymentParams The payment parameters.
+   * @param {Object} extraParams The extra parameters for the payment 
+   *                 procedure, including handler url, app title and spec.
+   * @param {Function} closeCallback The close callback in 
+   *                   <code>shindig.paymentprocessor</code>.
+   */
+  function cancelEvent(paymentParams, extraParams, closeCallback) {
+    // You can also show another acknowledge tab to say the order is canceled.
+    // Here just call the callback and return.
+    closeCallback();
+  };
+
+  /**
+   * Called by <code>shindig.paymentprocessor</code> when the counter 
+   * panel is closing.
+   * @param {Object} paymentParams The payment parameters.
+   * @param {Object} extraParams The extra parameters for the payment 
+   *                 procedure, including handler url, app title and spec.
+   */
+  function closeEvent(paymentParams, extraParams) {
+    // Set the div in the parent window to invisible.
+    parentDiv.style.display = 'none';
+  };
+
+  return {
+    /**
+     * Initializes the counter module.
+     * It's called by this page's body.onload() function.
+     * Note the payment processor object is passed from the parent window.
+     */
+    init: function() {
+      // Store the parent node in which there is an iframe holding this page.
+      parentDiv = window.frameElement.parentNode;
+
+      // Initialize the paymentprocessor module with four events.
+      // The container need to fully implement these event functions for
+      // UI/Backend interaction.
+      parent.shindig.paymentprocessor.init(openEvent,
+                                           submitEvent,
+                                           cancelEvent,
+                                           closeEvent);
+    }
+  };
+
+})();
+
+</script>
+</head>
+<body onload="myProcessorPanel.init();">
+  <!-- Customize the UI -->
+  <div class="payment-processor-shadow"></div>
+  <div class="payment-processor-border1">
+    <div class="payment-processor-border2">
+      <div class="payment-processor-content">
+        <p class="desc">
+          This panel is in an iframe from another page in the same container domain:<br>
+          <b><script>document.write(window.location.href);</script></b>
+        </p>
+        <p>
+          <div class="caption">Payment Type: </div><span id="payment-type"></span><br>
+          <div class="caption">Amount: </div><span id="payment-amount"></span><br>
+          <div class="caption">Message: </div><span id="payment-message"></span><br>
+          <div class="caption">App Name: </div><span id="payment-appname"></span><br>
+          <div class="caption">App Spec: </div><span id="payment-appspec"></span><br>
+          <div class="caption">Ordered Time: </div><span id="payment-orderedtime"></span><br>
+        </p>
+        <div id="button-tab" style="display:none;">
+          <button id="payment-submit">Submit</button>
+          <button id="payment-cancel">Cancel</button>
+        </div>
+        <div id="loading-tab" style="display:none">
+          Please wait...
+        </div>
+      </div>
+    </div>
+  </div>
+</body>
+</html>

Property changes on: javascript\container\sample-payment-processor.html
___________________________________________________________________
Added: svn:mime-type
   + text/html

Index: javascript/container/sample-payment.html
===================================================================
--- javascript/container/sample-payment.html	(revision 0)
+++ javascript/container/sample-payment.html	(revision 0)
@@ -0,0 +1,107 @@
+<!DOCTYPE html>
+<html>
+<head>
+<title>Sample: Payment</title>
+<!-- default container look and feel -->
+<link rel="stylesheet" href="gadgets.css">
+<style>
+  .gadgets-gadget-chrome {
+    width: 80%;
+    float: none;
+    margin: auto;
+  }
+  .gadgets-gadget {
+    width: 100%;
+  }
+  .desc {
+    color:#007F00;
+  }
+  .desc script {
+    color:#FF0000;
+  }
+  #payment-processor {
+    width:500px;
+    height:300px;
+    left:100px;
+    top:200px;
+    position:absolute;
+  }
+  #payment-processor iframe {
+    width:500px;
+    height:300px;
+  }
+</style>
+
+<script type="text/javascript" src="/gadgets/js/core:core.io:rpc:opensocial-payment.js?c=1&debug=1"></script>
+<script type="text/javascript" src="util.js"></script>
+<script type="text/javascript" src="gadgets.js"></script>
+<script type="text/javascript">
+
+function output(message) {
+  document.getElementById("output").innerHTML += gadgets.util.escapeString(message) + "<br/>";
+};
+
+var my = {};
+
+my.LayoutManager = function() {
+  gadgets.LayoutManager.call(this);
+};
+my.LayoutManager.inherits(gadgets.LayoutManager);
+my.LayoutManager.prototype.getGadgetChrome = function(gadget) {
+  var chromeId = 'gadget-chrome-' + gadget.id;
+  return chromeId ? document.getElementById(chromeId) : null;
+};
+my.renderGadgets = function() {
+  for (var i = 0; i < my.gadgetSpecUrls.length; ++i) {
+    var gadget = gadgets.container.createGadget(
+        {specUrl: my.gadgetSpecUrls[i], title: ("Sample App - " + i)});
+    gadgets.container.addGadget(gadget);
+    gadgets.container.renderGadget(gadget);
+  }
+};
+
+my.gadgetSpecUrls = [
+  'http://' + window.location.host + '/gadgets/files/container/sample-payment.xml'
+];
+
+my.init = function() {
+  gadgets.container.layoutManager = new my.LayoutManager();
+  
+  // To enable io and rpc feature on container side.
+  // Make sure extra features are added to the container side of 
+  // features/core/feature.xml and features/core.io/feature.xml
+  gadgets.config.init({
+    'rpc' : {
+      'parentRelayUrl' : '/gadgets/files/container/rpc_relay.html',
+      'useLegacyProtocol' : false
+    },
+  
+    'core.io' : {
+      'proxyUrl' : 'http://%host%/gadgets/proxy?refresh=%refresh%&url=%url%',
+      'jsonProxyUrl' : 'http://%host%/gadgets/makeRequest'
+    }
+  });
+};
+
+</script>
+</head>
+<body onLoad="my.init();my.renderGadgets()">
+  <center>
+    <h2>Sample: Virtual Currency Payment</h2>
+    <p class="desc">
+      This page is a container page:<br>
+      <b><script>document.write(window.location.href);</script></b>
+    </p>
+    </center>
+  <div id="gadget-chrome-0" class="gadgets-gadget-chrome"></div>
+
+  <div id="output" style="clear: left;">
+  </div>
+
+  <!-- The counter panel -->
+  <div id="payment-processor" style="display:none;">
+    <iframe name="payment-processor-frame" frameborder=0 src="sample-payment-processor.html"></iframe>
+  </div>
+
+</body>
+</html>

Property changes on: javascript\container\sample-payment.html
___________________________________________________________________
Added: svn:mime-type
   + text/html

Index: javascript/container/sample-payment.xml
===================================================================
--- javascript/container/sample-payment.xml	(revision 0)
+++ javascript/container/sample-payment.xml	(revision 0)
@@ -0,0 +1,143 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<Module>
+  <ModulePrefs title="My App Test"
+               author_email="yizi.wu@gmail.com" scrolling="true">
+    <Require feature="opensocial-0.8"/>
+    <Require feature="dynamic-height"/>
+    <Require feature="settitle"/>
+    <Require feature="views"/>
+    <Require feature="rpc"/>
+  </ModulePrefs>
+  <Content type="html" view="default">
+    <![CDATA[
+      <style>
+        #main {
+          font-size:13px;
+        }
+        .t {
+          width:300px;
+        }
+        .f {
+          border-collapse:collapse;
+          margin-left:10px;
+        }
+        .f tbody tr td {
+          font-size:12px;
+          font-weight:bold;
+          white-space:nowrap;
+          vertical-align:top;
+        }
+        .f tbody tr td span {
+          font-size:10px;
+          white-space:normal;
+        }
+        .desc {
+          color:#007F7F;
+        }
+        </style>
+      <script>
+
+        function requestPayment() {
+          var paymentHandlerUrl = document.getElementById('backend').value;
+          var params = {};
+          params[opensocial.Payment.Field.AMOUNT] = document.getElementById('amount').value;
+          params[opensocial.Payment.Field.MESSAGE] = document.getElementById('message').value;
+          params[opensocial.Payment.Field.PARAMETERS] = gadgets.util.escapeString(document.getElementById('parameters').value);
+          params[opensocial.Payment.Field.PAYMENT_TYPE] = document.getElementById('creditType').checked ? 
+              opensocial.Payment.PaymentType.CREDIT : opensocial.Payment.PaymentType.PAYMENT;
+          
+          if (window.console) {
+            window.console.log(params);
+          }
+          
+          var payment = opensocial.newPayment(params);
+
+          opensocial.requestPayment(payment, paymentHandlerUrl, function(responseItem) {
+            document.getElementById('res').style.display = 'block';
+
+            document.getElementById('status').innerHTML = responseItem.hadError() ? 'FAILED' : 'SUCCESS';
+            
+            var data = responseItem.getData();
+            document.getElementById('type').innerHTML = data.getField(opensocial.Payment.Field.PAYMENT_TYPE);
+            document.getElementById('orderid').innerHTML = data.getField(opensocial.Payment.Field.ORDER_ID);
+            document.getElementById('code').innerHTML = data.getField(opensocial.Payment.Field.RESPONSE_CODE);
+            document.getElementById('resmsg').innerHTML = data.getField(opensocial.Payment.Field.RESPONSE_MESSAGE);
+            document.getElementById('orderedtime').innerHTML = new Date(data.getField(opensocial.Payment.Field.ORDERED_TIME));
+            document.getElementById('submittedtime').innerHTML = new Date(data.getField(opensocial.Payment.Field.SUBMITTED_TIME));
+            document.getElementById('executedtime').innerHTML = new Date(data.getField(opensocial.Payment.Field.EXECUTED_TIME));
+
+            gadgets.window.adjustHeight();
+          });
+          document.getElementById('res').style.display = 'none';
+
+        };
+
+        function changeTitle() {
+          var title = document.getElementById('title').value;
+          gadgets.window.setTitle(title);
+        };
+
+        function init() {
+          document.getElementById('view').innerHTML = 'Current View: <b>' + gadgets.views.getCurrentView().getName() + '</b>';
+          var req = opensocial.newDataRequest();
+          req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER), "req");
+          req.send(function(data) {
+            if (!data.hadError()) {
+              document.getElementById('myname').innerHTML = 'Current Viewer: <b>' + data.get("req").getData().getDisplayName() + '</b>';
+            }
+            gadgets.window.adjustHeight();
+          });
+        };
+        gadgets.util.registerOnLoadHandler(init);
+      </script>
+
+
+      <div id="main">
+        <p class="desc">
+            Here is the app domain inside the gadget iframe, usually different from container domain:<br>
+            <b><script>document.write('http://' + window.location.host + window.location.pathname + location.search.substring(0, 30) + '...');</script></b>
+        </p>
+        <p>
+          <span id="myname"></span>
+          &nbsp;&nbsp;&nbsp;&nbsp;
+          <span id="view"></span>
+        </p>
+        <!--<p>
+          <input class=t id=title value="New Title">
+          <button onclick="changeTitle();">Change Title</button>
+        </p>-->
+        <hr>
+        <div id=req>
+          <b>Make a Payment Request: </b><br>
+          <table class=f><tbody>
+          <tr><td>Amount: </td><td><input class=t id=amount value=100></td></tr>
+          <tr><td>Message: </td><td><input class=t id=message value="You are ordering some flowers."></td></tr>
+          <tr><td>Parameters: </td><td><input class=t id=parameters value="{type:'Tulip',quantity:5}"></td></tr>
+          <tr><td>Payment Handler Url: </td><td><input class=t id=backend value="http://www.unickway.org.cn/vcdemo/mode-3/app-backend.php"></td></tr>
+          <tr><td>Payment Type: </td><td>
+              <input type=radio id=paymentType name=pt checked><label for=paymentType>Payment</label>
+              <input type=radio id=creditType name=pt><label for=creditType>Credit</label>
+          </td></tr>
+          </tbody></table>
+          <button onclick="requestPayment();">Request Payment</button>
+        </div>
+
+        <div id=res style="display:none">
+          <hr>
+          <b>Payment Response: </b><br>
+          <table class=f><tbody>
+          <tr><td>Payment Type: </td><td><span id=type></span></td></tr>
+          <tr><td>Status: </td><td><span id=status></span></td></tr>
+          <tr><td>Order ID: </td><td><span id=orderid></span></td></tr>
+          <tr><td>Response Code: </td><td><span id=code></span></td></tr>
+          <tr><td>Response Message: </td><td><span id=resmsg></span></td></tr>
+          <tr><td>Ordered Time: </td><td><span id=orderedtime></span></td></tr>
+          <tr><td>Submitted Time: </td><td><span id=submittedtime></span></td></tr>
+          <tr><td>Executed Time: </td><td><span id=executedtime></span></td></tr>
+          </tbody></table>
+        </div>
+      </div>
+     ]]>
+  </Content>
+</Module>
+

Property changes on: javascript\container\sample-payment.xml
___________________________________________________________________
Added: svn:mime-type
   + text/xml

Index: run.bat
===================================================================
--- run.bat	(revision 0)
+++ run.bat	(revision 0)
@@ -0,0 +1 @@
+mvn -Prun
\ No newline at end of file
